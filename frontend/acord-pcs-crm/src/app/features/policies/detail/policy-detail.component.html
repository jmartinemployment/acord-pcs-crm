<app-navbar [title]="policy()?.policyNumber || 'New Policy'" subtitle="Policy Details">
  <a routerLink="/policies" class="btn btn-outline-secondary me-2">
    <i class="bi bi-arrow-left me-1"></i> Back
  </a>
  @if (policy()) {
    <button class="btn btn-primary">
      <i class="bi bi-pencil me-1"></i> Edit
    </button>
  }
</app-navbar>

<div class="container-fluid px-4">
  @if (loading()) {
    <app-loading message="Loading policy details..." />
  } @else if (error()) {
    <div class="alert alert-danger">
      <i class="bi bi-exclamation-triangle me-2"></i>
      {{ error() }}
    </div>
  } @else if (policy()) {
    <div class="row">
      <!-- Main Info -->
      <div class="col-lg-8">
        <!-- Policy Overview -->
        <div class="card mb-4">
          <div class="card-header">
            <h5 class="card-title mb-0">
              <i class="bi bi-file-text me-2"></i>
              Policy Information
            </h5>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-4">
                <label class="form-label text-muted small">Policy Number</label>
                <p class="mb-0 fw-bold fs-5">{{ policy()!.policyNumber }}</p>
              </div>
              <div class="col-md-4">
                <label class="form-label text-muted small">Line of Business</label>
                <p class="mb-0">
                  <span class="badge bg-primary">{{ policy()!.lineOfBusiness }}</span>
                </p>
              </div>
              <div class="col-md-4">
                <label class="form-label text-muted small">Status</label>
                <p class="mb-0">
                  <span class="badge" [ngClass]="getStatusClass(policy()!.policyStatus)">
                    {{ policy()!.policyStatus }}
                  </span>
                </p>
              </div>
              <div class="col-md-4">
                <label class="form-label text-muted small">Effective Date</label>
                <p class="mb-0">{{ policy()!.effectiveDate | date }}</p>
              </div>
              <div class="col-md-4">
                <label class="form-label text-muted small">Expiration Date</label>
                <p class="mb-0">{{ policy()!.expirationDate | date }}</p>
              </div>
              <div class="col-md-4">
                <label class="form-label text-muted small">Carrier</label>
                <p class="mb-0">{{ policy()!.carrierName || '—' }}</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Vehicles (if any) -->
        @if (policy()!.vehicles && policy()!.vehicles!.length > 0) {
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="card-title mb-0">
                <i class="bi bi-car-front me-2"></i>
                Vehicles
              </h5>
            </div>
            <div class="card-body p-0">
              <table class="table table-hover mb-0">
                <thead class="table-light">
                  <tr>
                    <th>Year/Make/Model</th>
                    <th>VIN</th>
                    <th>Use</th>
                    <th>Value</th>
                  </tr>
                </thead>
                <tbody>
                  @for (v of policy()!.vehicles; track v.id) {
                    <tr>
                      <td>{{ v.year }} {{ v.make }} {{ v.model }}</td>
                      <td><code>{{ v.vin || '—' }}</code></td>
                      <td>{{ v.vehicleUse || '—' }}</td>
                      <td>{{ v.statedAmount | currency }}</td>
                    </tr>
                  }
                </tbody>
              </table>
            </div>
          </div>
        }

        <!-- Properties (if any) -->
        @if (policy()!.properties && policy()!.properties!.length > 0) {
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="card-title mb-0">
                <i class="bi bi-house me-2"></i>
                Properties
              </h5>
            </div>
            <div class="card-body p-0">
              <table class="table table-hover mb-0">
                <thead class="table-light">
                  <tr>
                    <th>Address</th>
                    <th>Type</th>
                    <th>Year Built</th>
                    <th>Building Value</th>
                  </tr>
                </thead>
                <tbody>
                  @for (p of policy()!.properties; track p.id) {
                    <tr>
                      <td>{{ p.address }}, {{ p.city }}, {{ p.state }} {{ p.zip }}</td>
                      <td>{{ p.propertyType || '—' }}</td>
                      <td>{{ p.yearBuilt || '—' }}</td>
                      <td>{{ p.buildingValue | currency }}</td>
                    </tr>
                  }
                </tbody>
              </table>
            </div>
          </div>
        }

        <!-- Coverages -->
        @if (policy()!.coverages && policy()!.coverages!.length > 0) {
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="card-title mb-0">
                <i class="bi bi-shield-check me-2"></i>
                Coverages
              </h5>
            </div>
            <div class="card-body p-0">
              <table class="table table-hover mb-0">
                <thead class="table-light">
                  <tr>
                    <th>Coverage</th>
                    <th>Limit</th>
                    <th>Deductible</th>
                    <th>Premium</th>
                  </tr>
                </thead>
                <tbody>
                  @for (c of policy()!.coverages; track c.id) {
                    <tr>
                      <td>
                        <strong>{{ c.coverageCode }}</strong>
                        @if (c.coverageDesc) {
                          <br /><small class="text-muted">{{ c.coverageDesc }}</small>
                        }
                      </td>
                      <td>{{ c.limitAmount | currency }}</td>
                      <td>{{ c.deductibleAmount | currency }}</td>
                      <td>{{ c.premiumAmount | currency }}</td>
                    </tr>
                  }
                </tbody>
              </table>
            </div>
          </div>
        }
      </div>

      <!-- Sidebar -->
      <div class="col-lg-4">
        <!-- Premium Summary -->
        <div class="card mb-4">
          <div class="card-header">
            <h5 class="card-title mb-0">
              <i class="bi bi-currency-dollar me-2"></i>
              Premium
            </h5>
          </div>
          <div class="card-body">
            <div class="text-center mb-3">
              <span class="fs-2 fw-bold text-success">
                {{ policy()!.writtenPremium || policy()!.annualPremium | currency }}
              </span>
              <p class="text-muted mb-0">Written Premium</p>
            </div>
            @if (policy()!.annualPremium && policy()!.annualPremium !== policy()!.writtenPremium) {
              <div class="d-flex justify-content-between">
                <span class="text-muted">Annual Premium</span>
                <span>{{ policy()!.annualPremium | currency }}</span>
              </div>
            }
          </div>
        </div>

        <!-- Renewal Alert -->
        @if (policy()!.policyStatus === 'ACTIVE' && daysUntilExpiration <= 90) {
          <div class="card mb-4 border-warning">
            <div class="card-header bg-warning text-dark">
              <h5 class="card-title mb-0">
                <i class="bi bi-exclamation-triangle me-2"></i>
                Renewal Alert
              </h5>
            </div>
            <div class="card-body">
              <p class="mb-2">
                This policy expires in
                <strong class="text-danger">{{ daysUntilExpiration }} days</strong>
              </p>
              <button class="btn btn-warning btn-sm w-100">
                <i class="bi bi-arrow-repeat me-1"></i>
                Start Renewal
              </button>
            </div>
          </div>
        }

        <!-- Policy Parties -->
        @if (policy()!.parties && policy()!.parties!.length > 0) {
          <div class="card">
            <div class="card-header">
              <h5 class="card-title mb-0">
                <i class="bi bi-people me-2"></i>
                Involved Parties
              </h5>
            </div>
            <ul class="list-group list-group-flush">
              @for (pp of policy()!.parties; track pp.id) {
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  <div>
                    @if (pp.party) {
                      <a [routerLink]="['/parties', pp.partyId]" class="text-decoration-none">
                        {{ pp.party.partyType === 'PERSON'
                          ? pp.party.firstName + ' ' + pp.party.lastName
                          : pp.party.commercialName }}
                      </a>
                    } @else {
                      <span>Party ID: {{ pp.partyId }}</span>
                    }
                  </div>
                  <span class="badge bg-secondary">{{ pp.role }}</span>
                </li>
              }
            </ul>
          </div>
        }
      </div>
    </div>
  }
</div>
