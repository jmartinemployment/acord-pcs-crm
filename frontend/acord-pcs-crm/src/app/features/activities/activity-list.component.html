<app-navbar title="Activities" subtitle="Manage tasks and activities">
  <button class="btn btn-primary">
    <i class="bi bi-plus-lg me-1"></i> New Activity
  </button>
</app-navbar>

<div class="container-fluid px-4">
  <!-- Summary Cards -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="card bg-danger bg-opacity-10 border-danger">
        <div class="card-body text-center">
          <h3 class="text-danger mb-0">{{ overdueCount }}</h3>
          <small class="text-muted">Overdue</small>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-warning bg-opacity-10 border-warning">
        <div class="card-body text-center">
          <h3 class="text-warning mb-0">{{ dueTodayCount }}</h3>
          <small class="text-muted">Due Today</small>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-info bg-opacity-10 border-info">
        <div class="card-body text-center">
          <h3 class="text-info mb-0">{{ pendingCount }}</h3>
          <small class="text-muted">Pending</small>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-secondary bg-opacity-10">
        <div class="card-body text-center">
          <h3 class="mb-0">{{ activities().length }}</h3>
          <small class="text-muted">Total</small>
        </div>
      </div>
    </div>
  </div>

  <!-- Filters -->
  <div class="card mb-4">
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-3">
          <select
            class="form-select"
            [ngModel]="filterStatus()"
            (ngModelChange)="filterStatus.set($event)">
            <option value="">All Statuses</option>
            <option value="PENDING">Pending</option>
            <option value="IN_PROGRESS">In Progress</option>
            <option value="COMPLETED">Completed</option>
            <option value="CANCELLED">Cancelled</option>
          </select>
        </div>
        <div class="col-md-3">
          <select
            class="form-select"
            [ngModel]="filterType()"
            (ngModelChange)="filterType.set($event)">
            <option value="">All Types</option>
            <option value="CALL">Call</option>
            <option value="EMAIL">Email</option>
            <option value="MEETING">Meeting</option>
            <option value="TASK">Task</option>
            <option value="NOTE">Note</option>
            <option value="FOLLOW_UP">Follow-up</option>
          </select>
        </div>
        <div class="col-md-6 text-end">
          <span class="text-muted">
            {{ filteredActivities.length }} activities
          </span>
        </div>
      </div>
    </div>
  </div>

  <!-- Activity List -->
  <div class="card">
    <div class="card-body p-0">
      @if (loading()) {
        <div class="text-center py-5">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
        </div>
      } @else if (filteredActivities.length === 0) {
        <div class="text-center py-5 text-muted">
          <i class="bi bi-inbox fs-1 d-block mb-2"></i>
          No activities found
        </div>
      } @else {
        <div class="list-group list-group-flush">
          @for (activity of filteredActivities; track activity.id) {
            <div
              class="list-group-item list-group-item-action"
              [class.border-start]="activity.priority && activity.priority >= 3"
              [ngClass]="getPriorityClass(activity.priority)">
              <div class="d-flex align-items-start">
                <div class="activity-icon me-3">
                  <i class="bi {{ getTypeIcon(activity.activityType) }} fs-4"></i>
                </div>
                <div class="flex-grow-1">
                  <div class="d-flex justify-content-between align-items-start">
                    <div>
                      <h6 class="mb-1">
                        {{ activity.subject || activity.activityType }}
                      </h6>
                      @if (activity.description) {
                        <p class="text-muted small mb-1">{{ activity.description }}</p>
                      }
                      <div class="small">
                        @if (activity.party) {
                          <a [routerLink]="['/parties', activity.partyId]" class="me-3 text-decoration-none">
                            <i class="bi bi-person me-1"></i>
                            {{ activity.party.partyType === 'PERSON'
                              ? activity.party.firstName + ' ' + activity.party.lastName
                              : activity.party.commercialName }}
                          </a>
                        }
                        @if (activity.policy) {
                          <a [routerLink]="['/policies', activity.policyId]" class="me-3 text-decoration-none">
                            <i class="bi bi-file-text me-1"></i>
                            {{ activity.policy.policyNumber }}
                          </a>
                        }
                        @if (activity.dueDate) {
                          <span [class.text-danger]="isOverdue(activity)" [class.text-warning]="isDueToday(activity) && !isOverdue(activity)">
                            <i class="bi bi-calendar me-1"></i>
                            Due: {{ activity.dueDate | date:'shortDate' }}
                            @if (isOverdue(activity)) {
                              <span class="badge bg-danger ms-1">Overdue</span>
                            }
                            @if (isDueToday(activity) && !isOverdue(activity)) {
                              <span class="badge bg-warning text-dark ms-1">Today</span>
                            }
                          </span>
                        }
                      </div>
                    </div>
                    <div class="text-end">
                      <span class="badge" [ngClass]="getStatusClass(activity.activityStatus)">
                        {{ activity.activityStatus }}
                      </span>
                      <div class="small text-muted mt-1">
                        {{ activity.createdAt | date:'short' }}
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          }
        </div>
      }
    </div>
  </div>
</div>
